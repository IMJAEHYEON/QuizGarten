<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>QuizGarten</title>
    <link rel="icon" href="/assets/logo/logo.png">
    <link rel="stylesheet" href="/css/MainStyle.css">
    <script src="/js/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        // onload í•¨ìˆ˜ì— ì¶”ê°€
        window.onload = function () {
            const sessionUserId = /*[[${SS_USER_ID}]]*/ null;
            if (!sessionUserId) {
                alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                location.href = "/main/mainPage";
                return;
            }

            const quizType = getQuizTypeFromUrl();
            const categoryInput = document.getElementById('quizCategory');
            if (quizType === 'ai') {
                categoryInput.disabled = false;
                categoryInput.placeholder = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            } else {
                categoryInput.disabled = true;
                categoryInput.placeholder = 'AI í€´ì¦ˆ ì„ íƒ ì‹œë§Œ ì…ë ¥ ê°€ëŠ¥';
            }

            document.getElementById('thumbnailInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                const previewImage = document.getElementById('thumbnailPreviewImage');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImage.style.display = 'none';
                }
            });
        };


        function getQuizTypeFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('type');
        }

        function validateAndProceed() {
            const titleInput = document.getElementById('quizTitle');
            const descriptionInput = document.getElementById('quizDescription');
            const titleError = document.getElementById('titleError');
            const descriptionError = document.getElementById('descriptionError');

            let isValid = true;

            if (!titleInput.value.trim()) {
                titleError.style.display = 'block';
                isValid = false;
            } else {
                titleError.style.display = 'none';
            }

            if (!descriptionInput.value.trim()) {
                descriptionError.style.display = 'block';
                isValid = false;
            } else {
                descriptionError.style.display = 'none';
            }

            if (!isValid) return;

            const file = document.getElementById('thumbnailInput').files[0];
            const selectedQuizType = getQuizTypeFromUrl();
            const sessionUserId = /*[[${SS_USER_ID}]]*/ null;

            if (file) {
                const uploadForm = new FormData();
                uploadForm.append("file", file); // ğŸ”§ S3 ì—…ë¡œë“œìš© í‚¤ëŠ” "file"

                fetch("/s3/SingleUpload", {
                    method: "POST",
                    body: uploadForm
                })
                    .then(res => res.text())
                    .then(s3Url => {
                        submitQuizData(titleInput.value, descriptionInput.value, s3Url);
                    })
                    .catch(() => alert("ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨"));
            } else {
                submitQuizData(titleInput.value, descriptionInput.value, null);
            }
        }

        // submitQuizData í•¨ìˆ˜ ì•ˆì—ì„œ category ê°’ í¬í•¨
        function submitQuizData(title, description, s3Url) {
            const selectedQuizType = getQuizTypeFromUrl();
            const sessionUserId = /*[[${SS_USER_ID}]]*/ null;
            const categoryValue = document.getElementById('quizCategory').value;

            const quizInfo = {
                quiz: {
                    quizType: selectedQuizType,
                    quizTitle: title,
                    description: description,
                    visibility: document.getElementById('isPublic').checked ? 'Y' : 'N',
                    userId: sessionUserId,
                    quizChgId: sessionUserId,
                    quizComment: "",
                    thumbnailUrl: s3Url || "",
                    quizCategory: selectedQuizType === 'ai' ? categoryValue : nul
                },
                details: []
            };

            const formData = new FormData();
            formData.append("quizInfo", new Blob([JSON.stringify(quizInfo)], { type: "application/json" }));

            $.ajax({
                url: '/quiz/quizCreate/saveInfo',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    window.location.href = `/quiz/quizCreate/question?type=${selectedQuizType}`;
                },
                error: function () {
                    alert("í€´ì¦ˆ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
    </script>
</head>
<body>
<div class="modal-backdrop">
    <div class="quiz-info-modal">
        <h2>í€´ì¦ˆ ë§Œë“¤ê¸°</h2>

        <div>
            <label for="quizTitle">ì œëª©</label>
            <input type="text" id="quizTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”. (ìµœëŒ€ 50ì)">
            <div class="error-message" id="titleError" style="display: none;">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>

        <div>
            <label for="quizDescription">ì„¤ëª…</label>
            <textarea id="quizDescription" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”. (ìµœëŒ€ 100ì)"></textarea>
            <div class="error-message" id="descriptionError" style="display: none;">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>

        <!-- HTML ì¶”ê°€ -->
        <div>
            <label for="quizCategory">ì¹´í…Œê³ ë¦¬ (AI ì œì‘ ì‹œ ìë™ ì„¤ì •)</label>
            <input type="text" id="quizCategory" placeholder="AI í€´ì¦ˆ ì„ íƒ ì‹œë§Œ ì…ë ¥ ê°€ëŠ¥" disabled>
        </div>


        <div>
            <label>ì¸ë„¤ì¼ (ì„ íƒ)</label>
            <input type="file" id="thumbnailInput" accept="image/*">
            <div class="thumbnail-preview">
                <img id="thumbnailPreviewImage" style="display: none;" alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°">
            </div>
        </div>

        <div>
            <label>ê³µê°œ ì—¬ë¶€</label>
            <input type="checkbox" id="isPublic">
        </div>

        <button onclick="validateAndProceed()">í™•ì¸</button>
    </div>
</div>
</body>
</html>