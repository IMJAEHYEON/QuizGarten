<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>QuizGarten</title>
    <link rel="icon" href="/assets/logo/logo.png">
    <link rel="stylesheet" href="/css/MainStyle.css">
    <script src="/js/jquery-3.6.0.min.js"></script>
</head>
<body>
<header>
    <img class="logo" src="/assets/logo/logo.png" alt="ë¡œê³ " onclick="goMain()" style="cursor:pointer;" />
    <div class="menu-buttons">
        <button onclick="openSettings()">ì„¤ì •</button>
        <button onclick="history.back()">ì·¨ì†Œ</button>
        <button onclick="saveQuiz()">ì €ì¥</button>
    </div>
</header>

<main>
    <div class="quiz-edit-container">
        <div id="questionList" class="quiz-container"></div>
    </div>
</main>

<!-- íŒì—… ì»¨í…Œì´ë„ˆ -->
<div id="popupContainer" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
    <div class="modal-content" id="popupContent" style="position: relative;">
        <button class="close-button" onclick="closePopup()">âœ–</button>
    </div>
</div>

<script th:inline="javascript">
    let quizId = new URLSearchParams(window.location.search).get("quiz");
    let quizType = null;

    $(document).ready(function() {
        const sessionUserId = /*[[${SS_USER_ID}]]*/ null;
        if (!sessionUserId) {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            location.href = "/main/mainPage";
            return;
        }

        if (!quizId) {
            openQuizTypeSelector();
        } else {
            loadQuestions();
        }
    });


    // ê¸°ì¡´ í€´ì¦ˆ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadQuestions() {
        fetch(`/quiz/info/${quizId}`)
            .then(res => res.ok ? res.json() : fetch(`/quiz/mongo/${quizId}/info`).then(r => r.json()))
            .then(info => {
                if (!info) {
                    renderEmptyQuestionList();
                    return;
                }
                quizType = info.quizType;
                window.quizCategory = info.quizCategory;
                fetchQuestions();
            })
            .catch(err => console.error("í€´ì¦ˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨", err));
    }



    function renderEmptyQuestionList() {
        const list = document.getElementById("questionList");
        const addCard = document.createElement("div");
        addCard.className = "quiz-card add-card";

        let innerHtml = `<div class="quiz-thumbnail" style="display:flex; align-items:center; justify-content:center; height: 100%;"><span style="font-size: 16px;">ë¬¸ì œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</span></div>`;


        // AI í€´ì¦ˆì¸ ê²½ìš° ìë™ ìƒì„± ë²„íŠ¼ë„ í•¨ê»˜ ì¶”ê°€
        if (quizType === 'ai') {
            innerHtml += `<button onclick="generateAiQuestions()" style="margin-top:10px;">AI ìë™ ìƒì„±</button>`;
        }

        addCard.innerHTML = innerHtml;
        addCard.onclick = () => selectQuizType(quizType);
        list.appendChild(addCard);
    }


    // ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ë° í™”ë©´ í‘œì‹œ
    function fetchQuestions() {
        fetch(`/quiz/mongo/${quizId}/questions`)
            .then(res => res.json())
            .then(questions => {
                window.loadedQuestions = questions;
                const list = document.getElementById("questionList");
                list.innerHTML = "";

                questions.forEach(q => {
                    const card = document.createElement("div");
                    card.id = `card-${q.quizDetailId}`;
                    card.className = "quiz-card edit-card";

                    let imageUrl = q.quizImageCut || q.imageUrl;

                    card.innerHTML = `
                    <div class="quiz-thumbnail">
                        <img src="${imageUrl || '/assets/logo/logo.png'}" alt="í€´ì¦ˆ ì¸ë„¤ì¼" />
                    </div>
                    <button class="delete-icon" onclick="deleteQuestion('${q.quizDetailId}', event)">ğŸ—‘ï¸</button>
                `;

                    card.onclick = () => editQuestion(q.quizDetailId);
                    list.appendChild(card);

                    // ìœ íŠœë¸Œ ì¸ë„¤ì¼ ìë™ í‘œì‹œ
                    if (!imageUrl && q.audioUrl) {
                        fetch(`/quiz/mongo/${quizId}/question/${q.quizDetailId}/youtube-id`)
                            .then(res => res.text())
                            .then(videoId => {
                                if (videoId && videoId !== "invalid_url") {
                                    const youtubeThumb = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                                    const img = card.querySelector("img");
                                    if (img) img.src = youtubeThumb;
                                }
                            });
                    }
                });

                renderEmptyQuestionList();
            });
    }



    // ë¬¸ì œ ìˆ˜ì •
    function editQuestion(quizDetailId) {
        const question = window.loadedQuestions.find(q => q.quizDetailId === quizDetailId);
        window.popupQuizId = quizId;
        window.popupQuizDetailId = quizDetailId;
        window.popupAnswers = question.answers || [];

        const url = `/quiz/makeQuiz${capitalizeFirstLetter(quizType)}Question?quiz=${quizId}&quizDetailId=${quizDetailId}`;
        loadPopup(url);
    }

    // ë¬¸ì œ ì¶”ê°€ íŒì—… (ìˆ˜ì •)
    function selectQuizType(type, questionId = null) {
        console.log("selectQuizType í˜¸ì¶œë¨", { quizId, type, questionId });
        let url = `/quiz/makeQuiz${capitalizeFirstLetter(type)}Question?quiz=${quizId}`;
        if (questionId) {
            url += `&questionId=${questionId}`; // ìˆ˜ì • ëª¨ë“œ ì§€ì›
        }
        console.log("ìƒì„±ëœ URL:", url);
        loadPopup(url);
    }


    // ë¬¸ì œ ì‚­ì œ
    function deleteQuestion(quizDetailId, event) {
        event.stopPropagation();
        if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`/quiz/mongo/${quizId}/question/${quizDetailId}`, { method: 'DELETE' })
            .then(() => {
                alert("ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchQuestions();
            })
            .catch(() => alert("ë¬¸ì œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }

    // ì„¤ì •(í€´ì¦ˆ ì •ë³´ ìˆ˜ì •)
    function openSettings() {
        const popupHtml = `
            <h2>í€´ì¦ˆ ì •ë³´ ìˆ˜ì •</h2>
            <input id="quizTitle" type="text" placeholder="ì œëª©" style="width:100%; margin-bottom:10px;" />
            <textarea id="quizDesc" placeholder="ì„¤ëª…" style="width:100%; margin-bottom:10px;"></textarea>
            <input id="quizThumbnailFile" type="file" accept="image/*" style="width:100%; margin-bottom:10px;" />
            <div id="thumbnailPreview" style="margin-bottom:10px;"></div>
            <div style="margin-bottom:10px;">
                <label>ê³µê°œ ì—¬ë¶€: <input id="quizPublic" type="checkbox" /></label>
            </div>
            <button onclick="saveQuizInfo()">í™•ì¸</button>
            <button onclick="closePopup()">ì·¨ì†Œ</button>
        `;
        $('#popupContent').html(popupHtml);
        $('#popupContainer').fadeIn(300);

        if (quizId) {
            fetch(`/quiz/mongo/${quizId}/info`)
                .then(res => res.json())
                .then(data => {
                    $('#quizTitle').val(data.title || '');
                    $('#quizDesc').val(data.description || '');
                    if (data.thumbnailUrl) {
                        $('#thumbnailPreview').html('<img src="' + data.thumbnailUrl + '" style="max-width:100%;height:auto;" />');
                    }
                    $('#quizPublic').prop('checked', data.visibility === 'Y');
                });
        }

        $(document).on('change', '#quizThumbnailFile', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    $('#thumbnailPreview').html('<img src="' + e.target.result + '" style="max-width:100%;height:auto;" />');
                };
                reader.readAsDataURL(file);
            } else {
                $('#thumbnailPreview').empty();
            }
        });
    }

    // ìƒˆ í€´ì¦ˆ ë§Œë“¤ê¸° - ìœ í˜• ì„ íƒ
    function openQuizTypeSelector() {
        const popupHtml = `
            <h2>í€´ì¦ˆ ë§Œë“¤ê¸° - ìœ í˜• ì„ íƒ</h2>
            <p>ì–´ë–¤ ìœ í˜•ì˜ í€´ì¦ˆë¥¼ ë§Œë“¤ê¹Œìš”?</p>
            <button onclick="startNewQuiz('image')">ì´ë¯¸ì§€ í€´ì¦ˆ</button>
            <button onclick="startNewQuiz('audio')">ì˜¤ë””ì˜¤ í€´ì¦ˆ</button>
            <button onclick="startNewQuiz('multiple')">ê°ê´€ì‹ í€´ì¦ˆ</button>
            <button onclick="startNewQuiz('ai')">AI ê°ê´€ì‹ í€´ì¦ˆ</button>
        `;
        $('#popupContent').html(popupHtml);
        $('#popupContainer').fadeIn(300);
    }

    // ìƒˆ í€´ì¦ˆ ìƒì„± í”„ë¡œì„¸ìŠ¤
    function startNewQuiz(type) {
        quizType = type;

        let popupHtml = '';

        if (type === 'ai') {
            // AI í€´ì¦ˆìš© í¼
            popupHtml = `
            <h2>AI ê°ê´€ì‹ í€´ì¦ˆ ì •ë³´ ì…ë ¥</h2>
            <input id="quizTitle" type="text" placeholder="ì œëª©" style="width:100%; margin-bottom:10px;" />
            <textarea id="quizDesc" placeholder="ì„¤ëª…" style="width:100%; margin-bottom:10px;"></textarea>
            <input id="quizCategory" type="text" placeholder="AI í€´ì¦ˆ ì£¼ì œ (ì˜ˆ: ë™ë¬¼, ê³¼ì¼)" style="width:100%; margin-bottom:10px;" />
            <input id="quizThumbnailFile" type="file" accept="image/*" style="width:100%; margin-bottom:10px;" />
            <div id="thumbnailPreview" style="margin-bottom:10px;"></div>
            <div style="margin-bottom:10px;">
                <label>ê³µê°œ ì—¬ë¶€: <input id="quizPublic" type="checkbox" /></label>
            </div>
            <button onclick="createQuiz()">í€´ì¦ˆ ìƒì„±</button>
            <button onclick="closePopup()">ì·¨ì†Œ</button>
        `;
        } else {
            // ì¼ë°˜ í€´ì¦ˆìš© í¼
            popupHtml = `
            <h2>í€´ì¦ˆ ì •ë³´ ì…ë ¥</h2>
            <input id="quizTitle" type="text" placeholder="ì œëª©" style="width:100%; margin-bottom:10px;" />
            <textarea id="quizDesc" placeholder="ì„¤ëª…" style="width:100%; margin-bottom:10px;"></textarea>
            <input id="quizThumbnailFile" type="file" accept="image/*" style="width:100%; margin-bottom:10px;" />
            <div id="thumbnailPreview" style="margin-bottom:10px;"></div>
            <div style="margin-bottom:10px;">
                <label>ê³µê°œ ì—¬ë¶€: <input id="quizPublic" type="checkbox" /></label>
            </div>
            <button onclick="createQuiz()">í€´ì¦ˆ ìƒì„±</button>
            <button onclick="closePopup()">ì·¨ì†Œ</button>
        `;
        }

        $('#popupContent').html(popupHtml);
    }



    // í€´ì¦ˆ ìƒì„± ìš”ì²­
    function createQuiz() {
        const title = $('#quizTitle').val().trim();
        const description = $('#quizDesc').val().trim();
        const fileInput = $('#quizThumbnailFile')[0];
        const visibility = $('#quizPublic').is(':checked') ? 'Y' : 'N';

        if (!title || !description || fileInput.files.length === 0) {
            alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('thumbnail', file);

        // S3 ì—…ë¡œë“œ
        fetch('/s3/SingleUpload', {
            method: 'POST',
            body: formData
        })
            .then(res => res.text())
            .then(s3Url => {
                const quizData = {
                    quizType,
                    quizTitle: title,
                    description,
                    thumbnailUrl: s3Url,
                    visibility,
                    quizCategory: quizType === 'ai' ? $('#quizCategory').val().trim() : null
                };
                const quizFormData = new FormData();
                quizFormData.append('quizInfo', new Blob([JSON.stringify({ quiz: quizData, details: [] })], { type: 'application/json' }));
                return fetch('/quiz/quizCreate/saveInfo', {
                    method: 'POST',
                    body: quizFormData
                });
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error("í€´ì¦ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return res.text();
            })
            .then(newQuizId => {
                quizId = newQuizId;
                console.log("ìƒˆë¡œ ìƒì„±ëœ quizId:", quizId);

                // íŒì—… ë‹«ê¸°
                closePopup();

                //  í˜ì´ì§€ ì´ë™ (í€´ì¦ˆID í¬í•¨)
                window.location.href = `/quiz/makeQuizEdit?quiz=${quizId}`;
            })

    }

    function generateAiQuestions() {
        if (!confirm("AIë¥¼ ì‚¬ìš©í•´ ê°ê´€ì‹ ë¬¸ì œë¥¼ ìë™ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/quiz/info/${quizId}`)
            .then(res => res.json())
            .then(info => {
                const dto = {
                    quizId: quizId,
                    prompt: "",
                    category: info.quizCategory || "ì¼ë°˜"
                };

                return fetch("/quiz/quiz/generate-ai", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });
            })
            .then(res => {
                if (!res.ok) throw new Error("AI ìƒì„± ì‹¤íŒ¨");
                return res.text();
            })
            .then(() => {
                alert("AI ê°ê´€ì‹ ë¬¸ì œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                fetchQuestions(); // ìƒˆë¡œê³ ì¹¨
            })
            .catch(err => {
                console.error("AI í€´ì¦ˆ ìƒì„± ì‹¤íŒ¨", err);
                alert("AI í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // íŒì—… ë¡œë”© (ì „ì—­ ë³€ìˆ˜ ì „ë‹¬ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
    function loadPopup(url) {
        const urlParams = new URLSearchParams(url.split('?')[1]);
        window.popupQuizId = urlParams.get("quiz");
        window.popupQuizDetailId = urlParams.get("quizDetailId");

        $('#popupContent').load(url, function () {
            $('#popupContent').prepend('<button class="close-button" onclick="closePopup()">âœ–</button>');
            $('#popupContent script').each(function () {
                $.globalEval(this.text || this.textContent || this.innerHTML || '');
            });
            $('#popupContainer').fadeIn();
        });
    }

    // íŒì—… ë‹«ê¸°
    function closePopup() {
        $('#popupContainer').fadeOut();
        location.reload();
    }

    // ì²« ê¸€ì ëŒ€ë¬¸ì ë³€í™˜
    function capitalizeFirstLetter(str) {
        return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    // í€´ì¦ˆ ì €ì¥
    function saveQuiz() {
        fetch(`/quiz/mongo/${quizId}/questions`)
            .then(res => res.json())
            .then(questions => {
                return fetch(`/quiz/mongo/${quizId}/questions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(questions)
                });
            })
            .then(() => {
                alert("í€´ì¦ˆê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/main/myPage";
            })
            .catch(() => {
                alert("í€´ì¦ˆ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // í€´ì¦ˆ ì •ë³´ ì €ì¥
    function saveQuizInfo() {
        const title = $('#quizTitle').val().trim();
        const description = $('#quizDesc').val().trim();
        const fileInput = $('#quizThumbnailFile')[0];
        const visibility = $('#quizPublic').is(':checked') ? 'Y' : 'N';

        if (!title || !description) {
            alert("ì œëª©ê³¼ ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const file = fileInput.files.length > 0 ? fileInput.files[0] : null;

        // ìˆ˜ì •ë¨: JSON ëŒ€ì‹  multipartë¡œ ì²˜ë¦¬ â†’ submitQuizInfo í˜¸ì¶œ
        submitQuizInfo(title, description, visibility, file); // ìˆ˜ì •ëœ í˜¸ì¶œ ë°©ì‹
    }

    // ìˆ˜ì •ë¨: multipart ìš”ì²­ìœ¼ë¡œ ì „í™˜
    function submitQuizInfo(title, description, visibility, file) {
        const quizPayload = {
            quizId, // quizIdëŠ” ì „ì—­ì—ì„œ ì„ ì–¸ë¨
            title,
            description,
            visibility
        };

        const formData = new FormData();
        formData.append("quiz", new Blob([JSON.stringify(quizPayload)], { type: "application/json" }));

        // í•­ìƒ ë™ì¼í•œ í‚¤ thumbnailFile ì‚¬ìš©
        if (file) {
            formData.append("thumbnailFile", file); // ìˆ˜ì •ëœ í‚¤
        }

        fetch(`/quiz/mongo/info`, {
            method: 'PUT',
            body: formData
        })
            .then(() => {
                alert("í€´ì¦ˆ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

                // í€´ì¦ˆ íƒ€ì… ì¬ì„¤ì •
                fetch(`/quiz/mongo/${quizId}/info`)
                    .then(res => res.json())
                    .then(data => {
                        quizType = data.quizType;
                        console.log("ì„¤ì • í›„ í€´ì¦ˆ íƒ€ì… ê°±ì‹ ë¨:", quizType);
                    });

                closePopup();
            })
            .catch(() => alert("í€´ì¦ˆ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }

    // ë©”ì¸ ì´ë™
    function goMain() {
        const sessionUserId = /*[[${SS_USER_ID}]]*/ null;
        location.href = sessionUserId ? "/main/mainLoginSuccess" : "/main/mainPage";
    }

</script>
</body>
</html>
